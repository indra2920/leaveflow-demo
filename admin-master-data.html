<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaveFlow - Master Data Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --admin-gradient: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            --danger-gradient: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        * { font-family: 'Inter', sans-serif; }

        body {
            background: linear-gradient(135deg, #f8f4ff 0%, #e8f0fe 100%);
            min-height: 100vh;
        }

        .navbar {
            background: var(--admin-gradient) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .card-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            border: none;
            padding: 20px 25px;
        }

        .nav-tabs {
            border: none;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: var(--card-shadow);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .nav-tabs .nav-link.active {
            background: var(--admin-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .btn {
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .table {
            border-radius: 15px;
            overflow: hidden;
        }

        .table thead th {
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 600;
        }

        .modal-content {
            border-radius: 20px;
            border: none;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
    </style>
</head><bo
dy>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-database me-2"></i>Master Data Management
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="admin-dashboard-fixed.html">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="masterDataTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="regions-tab" data-bs-toggle="tab" data-bs-target="#regions" type="button">
                    <i class="fas fa-globe me-2"></i>Wilayah Kerja
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="locations-tab" data-bs-toggle="tab" data-bs-target="#locations" type="button">
                    <i class="fas fa-map-marker-alt me-2"></i>Lokasi Kerja
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button">
                    <i class="fas fa-sitemap me-2"></i>Jabatan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                    <i class="fas fa-cog me-2"></i>Pengaturan
                </button>
            </li>
        </ul>

        <div class="tab-content" id="masterDataTabContent">
            <!-- Regions Tab -->
            <div class="tab-pane fade show active" id="regions">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-globe me-2"></i>Wilayah Kerja</h5>
                        <button class="btn btn-light" onclick="showRegionModal()">
                            <i class="fas fa-plus me-2"></i>Tambah Wilayah
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="regionsTable">
                                <thead>
                                    <tr>
                                        <th>Kode</th>
                                        <th>Nama Wilayah</th>
                                        <th>Deskripsi</th>
                                        <th>Jumlah Lokasi</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Locations Tab -->
            <div class="tab-pane fade" id="locations">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-map-marker-alt me-2"></i>Lokasi Kerja</h5>
                        <button class="btn btn-light" onclick="showLocationModal()">
                            <i class="fas fa-plus me-2"></i>Tambah Lokasi
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="locationsTable">
                                <thead>
                                    <tr>
                                        <th>Nama Lokasi</th>
                                        <th>Alamat</th>
                                        <th>Wilayah</th>
                                        <th>Jumlah Karyawan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Positions Tab -->
            <div class="tab-pane fade" id="positions">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-sitemap me-2"></i>Jabatan</h5>
                        <button class="btn btn-light" onclick="showPositionModal()">
                            <i class="fas fa-plus me-2"></i>Tambah Jabatan
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="positionsTable">
                                <thead>
                                    <tr>
                                        <th>Level</th>
                                        <th>Nama Jabatan</th>
                                        <th>Deskripsi</th>
                                        <th>Level Approval</th>
                                        <th>Jumlah Karyawan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-building me-2"></i>Informasi Perusahaan</h5>
                            </div>
                            <div class="card-body">
                                <form id="companyForm">
                                    <div class="mb-3">
                                        <label class="form-label">Nama Perusahaan</label>
                                        <input type="text" class="form-control" id="companyName">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Alamat</label>
                                        <textarea class="form-control" id="companyAddress" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Telepon</label>
                                        <input type="text" class="form-control" id="companyPhone">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="companyEmail">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveCompanySettings()">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-calendar-alt me-2"></i>Pengaturan Cuti</h5>
                            </div>
                            <div class="card-body">
                                <form id="leaveForm">
                                    <div class="mb-3">
                                        <label class="form-label">Maksimal Cuti Per Tahun</label>
                                        <input type="number" class="form-control" id="maxDaysPerYear" min="1" max="365">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Maksimal Cuti Berturut-turut</label>
                                        <input type="number" class="form-control" id="maxConsecutiveDays" min="1" max="30">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Minimal Pemberitahuan (Hari)</label>
                                        <input type="number" class="form-control" id="minNoticedays" min="0" max="30">
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireApproval">
                                            <label class="form-check-label" for="requireApproval">
                                                Memerlukan Persetujuan
                                            </label>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveLeaveSettings()">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!--
 Region Modal -->
    <div class="modal fade" id="regionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="regionModalTitle">Tambah Wilayah Kerja</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="regionForm">
                        <input type="hidden" id="regionId">
                        <div class="mb-3">
                            <label class="form-label">Kode Wilayah *</label>
                            <input type="text" class="form-control" id="regionCode" maxlength="5" required>
                            <div class="form-text">Maksimal 5 karakter, akan otomatis uppercase</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Wilayah *</label>
                            <input type="text" class="form-control" id="regionName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" id="regionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveRegion()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalTitle">Tambah Lokasi Kerja</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <input type="hidden" id="locationId">
                        <div class="mb-3">
                            <label class="form-label">Nama Lokasi *</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alamat</label>
                            <textarea class="form-control" id="locationAddress" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Wilayah *</label>
                            <select class="form-select" id="locationRegion" required>
                                <option value="">Pilih Wilayah</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveLocation()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Position Modal -->
    <div class="modal fade" id="positionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="positionModalTitle">Tambah Jabatan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="positionForm">
                        <input type="hidden" id="positionId">
                        <div class="mb-3">
                            <label class="form-label">Nama Jabatan *</label>
                            <input type="text" class="form-control" id="positionName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Level *</label>
                            <input type="number" class="form-control" id="positionLevel" min="1" max="10" required>
                            <div class="form-text">Level menentukan hierarki jabatan (1=terendah)</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Level Approval</label>
                            <input type="number" class="form-control" id="positionApprovalLevel" min="1" max="10">
                            <div class="form-text">Kosongkan untuk menggunakan level yang sama</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" id="positionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="savePosition()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth-protection.js"></script>
    <script src="master-data-manager.js"></script>
    <script src="realtime-database-manager.js"></script>
    <script src="fix-master-data-buttons.js"></script>
    <script src="test-master-data-save.js"></script>
    <script>
        // Global variables
        let currentEditId = null;
        let currentEditType = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('üöÄ Initializing Master Data page...');
                
                // Check admin role
                const currentUser = checkRole('admin');
                if (!currentUser) {
                    console.error('‚ùå Admin role check failed');
                    return;
                }
                console.log('‚úÖ Admin role verified');

                // Check if masterDataManager exists
                if (typeof masterDataManager === 'undefined') {
                    console.error('‚ùå masterDataManager not found');
                    alert('Error: Master Data Manager not loaded. Please refresh the page.');
                    return;
                }
                console.log('‚úÖ Master Data Manager loaded');

                // Load all data
                loadRegions();
                loadLocations();
                loadPositions();
                loadSettings();
                console.log('‚úÖ All data loaded');

                // Listen for data updates
                window.addEventListener('masterDataUpdated', function() {
                    console.log('üîÑ Data updated, refreshing...');
                    loadRegions();
                    loadLocations();
                    loadPositions();
                });
                
                // Listen for realtime data updates
                window.addEventListener('realtimeDataUpdate', function(event) {
                    console.log('üîÑ Realtime data update:', event.detail);
                    
                    // Refresh specific data based on what was updated
                    const { key } = event.detail;
                    if (key.includes('regions')) {
                        loadRegions();
                        loadLocationRegionOptions();
                    } else if (key.includes('locations')) {
                        loadLocations();
                        loadRegions(); // Update location counts
                    } else if (key.includes('positions')) {
                        loadPositions();
                    }
                });
                
                console.log('‚úÖ Master Data page initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing Master Data page:', error);
                alert('Error initializing page: ' + error.message);
            }
        });

        // ==================== REGIONS MANAGEMENT ====================

        function loadRegions() {
            console.log('üìä Loading regions...');
            
            const regions = realtimeDB.getData('leaveflow_regions');
            const tbody = document.querySelector('#regionsTable tbody');
            
            if (!tbody) {
                console.error('‚ùå Regions table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (regions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Belum ada data wilayah kerja
                        </td>
                    </tr>
                `;
                return;
            }
            
            regions.forEach(region => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge bg-primary">${region.code}</span></td>
                    <td><strong>${region.name}</strong></td>
                    <td>${region.description || '-'}</td>
                    <td><span class="badge bg-info">${region.locationCount || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editRegion(${region.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRegion(${region.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Loaded ${regions.length} regions`);
        }

        function showRegionModal(id = null) {
            console.log('üåç showRegionModal called with id:', id);
            currentEditId = id;
            currentEditType = 'region';
            
            try {
                const modalElement = document.getElementById('regionModal');
                if (!modalElement) {
                    throw new Error('Region modal element not found');
                }
                
                const modal = new bootstrap.Modal(modalElement);
                const title = document.getElementById('regionModalTitle');
                
                if (!title) {
                    throw new Error('Region modal title element not found');
                }
            
            if (id) {
                title.textContent = 'Edit Wilayah Kerja';
                const region = masterDataManager.getRegions().find(r => r.id === id);
                if (region) {
                    document.getElementById('regionId').value = region.id;
                    document.getElementById('regionCode').value = region.code;
                    document.getElementById('regionName').value = region.name;
                    document.getElementById('regionDescription').value = region.description || '';
                }
            } else {
                title.textContent = 'Tambah Wilayah Kerja';
                document.getElementById('regionForm').reset();
                document.getElementById('regionId').value = '';
            }
            
            modal.show();
        }

        function saveRegion() {
            console.log('üíæ saveRegion called');
            
            const id = document.getElementById('regionId').value;
            const regionData = {
                code: document.getElementById('regionCode').value.trim().toUpperCase(),
                name: document.getElementById('regionName').value.trim(),
                description: document.getElementById('regionDescription').value.trim()
            };

            console.log('üìù Region data:', regionData);

            // Validation
            if (!regionData.code || !regionData.name) {
                showAlert('Kode dan Nama Wilayah harus diisi!', 'warning');
                return;
            }

            if (regionData.code.length > 5) {
                showAlert('Kode Wilayah maksimal 5 karakter!', 'warning');
                return;
            }

            try {
                let result;
                
                if (id) {
                    // Update using realtime database
                    result = realtimeDB.saveRegion(regionData, true, id);
                    showAlert('Wilayah berhasil diupdate!', 'success');
                    console.log('‚úÖ Region updated successfully');
                } else {
                    // Create using realtime database
                    result = realtimeDB.saveRegion(regionData, false);
                    showAlert('Wilayah berhasil ditambahkan!', 'success');
                    console.log('‚úÖ Region created successfully');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('regionModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Refresh data
                setTimeout(() => {
                    loadRegions();
                    loadLocationRegionOptions();
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error saving region:', error);
                showAlert(error.message, 'danger');
            }
        }

        function editRegion(id) {
            showRegionModal(id);
        }

        function deleteRegion(id) {
            const region = masterDataManager.getRegions().find(r => r.id === id);
            if (!region) return;

            if (confirm(`Apakah Anda yakin ingin menghapus wilayah "${region.name}"?`)) {
                try {
                    masterDataManager.deleteRegion(id);
                    showAlert('Wilayah berhasil dihapus!', 'success');
                    loadRegions();
                    loadLocationRegionOptions();
                } catch (error) {
                    showAlert(error.message, 'danger');
                }
            }
        }

        // ==================== LOCATIONS MANAGEMENT ====================

        function loadLocations() {
            console.log('üìä Loading locations...');
            
            const locations = realtimeDB.getData('leaveflow_locations');
            const tbody = document.querySelector('#locationsTable tbody');
            
            if (!tbody) {
                console.error('‚ùå Locations table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (locations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Belum ada data lokasi kerja
                        </td>
                    </tr>
                `;
                return;
            }
            
            locations.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${location.name}</strong></td>
                    <td>${location.address || '-'}</td>
                    <td><span class="badge bg-secondary">${location.region_name || 'Unknown'}</span></td>
                    <td><span class="badge bg-info">${location.employeeCount || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editLocation(${location.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLocation(${location.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Loaded ${locations.length} locations`);
        }

        function showLocationModal(id = null) {
            currentEditId = id;
            currentEditType = 'location';
            
            loadLocationRegionOptions();
            
            const modal = new bootstrap.Modal(document.getElementById('locationModal'));
            const title = document.getElementById('locationModalTitle');
            
            if (id) {
                title.textContent = 'Edit Lokasi Kerja';
                const location = masterDataManager.getLocations().find(l => l.id === id);
                if (location) {
                    document.getElementById('locationId').value = location.id;
                    document.getElementById('locationName').value = location.name;
                    document.getElementById('locationAddress').value = location.address || '';
                    document.getElementById('locationRegion').value = location.region_id;
                }
            } else {
                title.textContent = 'Tambah Lokasi Kerja';
                document.getElementById('locationForm').reset();
                document.getElementById('locationId').value = '';
            }
            
            modal.show();
        }

        function loadLocationRegionOptions() {
            console.log('üìä Loading region options...');
            
            const regions = realtimeDB.getData('leaveflow_regions');
            const select = document.getElementById('locationRegion');
            
            if (!select) {
                console.error('‚ùå Location region select not found');
                return;
            }
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Pilih Wilayah</option>';
            
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = `${region.name} (${region.code})`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${regions.length} region options`);
        }

        function saveLocation() {
            console.log('üíæ saveLocation called');
            
            const id = document.getElementById('locationId').value;
            const locationData = {
                name: document.getElementById('locationName').value.trim(),
                address: document.getElementById('locationAddress').value.trim(),
                region_id: parseInt(document.getElementById('locationRegion').value)
            };

            console.log('üìù Location data:', locationData);

            // Validation
            if (!locationData.name || !locationData.region_id) {
                showAlert('Nama Lokasi dan Wilayah harus diisi!', 'warning');
                return;
            }

            try {
                let result;
                
                if (id) {
                    // Update using realtime database
                    result = realtimeDB.saveLocation(locationData, true, id);
                    showAlert('Lokasi berhasil diupdate!', 'success');
                    console.log('‚úÖ Location updated successfully');
                } else {
                    // Create using realtime database
                    result = realtimeDB.saveLocation(locationData, false);
                    showAlert('Lokasi berhasil ditambahkan!', 'success');
                    console.log('‚úÖ Location created successfully');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Refresh data
                setTimeout(() => {
                    loadLocations();
                    loadRegions(); // Update location counts
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error saving location:', error);
                showAlert(error.message, 'danger');
            }
        }

        function editLocation(id) {
            showLocationModal(id);
        }

        function deleteLocation(id) {
            const location = masterDataManager.getLocations().find(l => l.id === id);
            if (!location) return;

            if (confirm(`Apakah Anda yakin ingin menghapus lokasi "${location.name}"?`)) {
                try {
                    masterDataManager.deleteLocation(id);
                    showAlert('Lokasi berhasil dihapus!', 'success');
                    loadLocations();
                    loadRegions(); // Update location counts
                } catch (error) {
                    showAlert(error.message, 'danger');
                }
            }
        }        /
/ ==================== POSITIONS MANAGEMENT ====================

        function loadPositions() {
            console.log('üìä Loading positions...');
            
            const positions = realtimeDB.getData('leaveflow_positions');
            const tbody = document.querySelector('#positionsTable tbody');
            
            if (!tbody) {
                console.error('‚ùå Positions table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Belum ada data jabatan
                        </td>
                    </tr>
                `;
                return;
            }
            
            positions.forEach(position => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge bg-primary">${position.level}</span></td>
                    <td><strong>${position.name}</strong></td>
                    <td>${position.description || '-'}</td>
                    <td><span class="badge bg-warning">${position.approval_level}</span></td>
                    <td><span class="badge bg-info">${position.employeeCount || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editPosition(${position.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePosition(${position.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Loaded ${positions.length} positions`);
        }

        function showPositionModal(id = null) {
            currentEditId = id;
            currentEditType = 'position';
            
            const modal = new bootstrap.Modal(document.getElementById('positionModal'));
            const title = document.getElementById('positionModalTitle');
            
            if (id) {
                title.textContent = 'Edit Jabatan';
                const position = masterDataManager.getPositions().find(p => p.id === id);
                if (position) {
                    document.getElementById('positionId').value = position.id;
                    document.getElementById('positionName').value = position.name;
                    document.getElementById('positionLevel').value = position.level;
                    document.getElementById('positionApprovalLevel').value = position.approval_level;
                    document.getElementById('positionDescription').value = position.description || '';
                }
            } else {
                title.textContent = 'Tambah Jabatan';
                document.getElementById('positionForm').reset();
                document.getElementById('positionId').value = '';
            }
            
            modal.show();
        }

        function savePosition() {
            console.log('üíæ savePosition called');
            
            const id = document.getElementById('positionId').value;
            const level = parseInt(document.getElementById('positionLevel').value);
            const approvalLevel = document.getElementById('positionApprovalLevel').value;
            
            const positionData = {
                name: document.getElementById('positionName').value.trim(),
                level: level,
                approval_level: approvalLevel ? parseInt(approvalLevel) : level,
                description: document.getElementById('positionDescription').value.trim()
            };

            console.log('üìù Position data:', positionData);

            // Validation
            if (!positionData.name || !positionData.level) {
                showAlert('Nama Jabatan dan Level harus diisi!', 'warning');
                return;
            }

            if (positionData.level < 1 || positionData.level > 10) {
                showAlert('Level harus antara 1-10!', 'warning');
                return;
            }

            try {
                let result;
                
                if (id) {
                    // Update using realtime database
                    result = realtimeDB.savePosition(positionData, true, id);
                    showAlert('Jabatan berhasil diupdate!', 'success');
                    console.log('‚úÖ Position updated successfully');
                } else {
                    // Create using realtime database
                    result = realtimeDB.savePosition(positionData, false);
                    showAlert('Jabatan berhasil ditambahkan!', 'success');
                    console.log('‚úÖ Position created successfully');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('positionModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Refresh data
                setTimeout(() => {
                    loadPositions();
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error saving position:', error);
                showAlert(error.message, 'danger');
            }
        }

        function editPosition(id) {
            showPositionModal(id);
        }

        function deletePosition(id) {
            const position = masterDataManager.getPositions().find(p => p.id === id);
            if (!position) return;

            if (confirm(`Apakah Anda yakin ingin menghapus jabatan "${position.name}"?`)) {
                try {
                    masterDataManager.deletePosition(id);
                    showAlert('Jabatan berhasil dihapus!', 'success');
                    loadPositions();
                } catch (error) {
                    showAlert(error.message, 'danger');
                }
            }
        }

        // ==================== SETTINGS MANAGEMENT ====================

        function loadSettings() {
            const settings = masterDataManager.getSettings();
            
            // Company settings
            document.getElementById('companyName').value = settings.company?.name || '';
            document.getElementById('companyAddress').value = settings.company?.address || '';
            document.getElementById('companyPhone').value = settings.company?.phone || '';
            document.getElementById('companyEmail').value = settings.company?.email || '';
            
            // Leave settings
            document.getElementById('maxDaysPerYear').value = settings.leave?.maxDaysPerYear || 12;
            document.getElementById('maxConsecutiveDays').value = settings.leave?.maxConsecutiveDays || 5;
            document.getElementById('minNoticedays').value = settings.leave?.minNoticedays || 3;
            document.getElementById('requireApproval').checked = settings.leave?.requireApproval !== false;
        }

        function saveCompanySettings() {
            const companyData = {
                company: {
                    name: document.getElementById('companyName').value.trim(),
                    address: document.getElementById('companyAddress').value.trim(),
                    phone: document.getElementById('companyPhone').value.trim(),
                    email: document.getElementById('companyEmail').value.trim()
                }
            };

            try {
                masterDataManager.updateSettings(companyData);
                showAlert('Pengaturan perusahaan berhasil disimpan!', 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        function saveLeaveSettings() {
            const leaveData = {
                leave: {
                    maxDaysPerYear: parseInt(document.getElementById('maxDaysPerYear').value),
                    maxConsecutiveDays: parseInt(document.getElementById('maxConsecutiveDays').value),
                    minNoticedays: parseInt(document.getElementById('minNoticedays').value),
                    requireApproval: document.getElementById('requireApproval').checked
                }
            };

            try {
                masterDataManager.updateSettings(leaveData);
                showAlert('Pengaturan cuti berhasil disimpan!', 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================

        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Auto-uppercase region code
        document.addEventListener('DOMContentLoaded', function() {
            const regionCodeInput = document.getElementById('regionCode');
            if (regionCodeInput) {
                regionCodeInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        });
    </script>
</body>
</html>